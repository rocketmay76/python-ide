<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Python IDE">
    <title>Python IDE</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        body {
            overscroll-behavior: none;
            touch-action: pan-y;
        }
        textarea {
            font-family: 'Courier New', monospace;
        }
        .line-highlight {
            pointer-events: none;
        }
    </style>
</head>
<body class="m-0 p-0 overflow-hidden">
    <div id="root"></div>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // SVG Icons as components
        const PlayIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        );
        
        const RotateCcwIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="1 4 1 10 7 10"></polyline>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
        );
        
        const SaveIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
        );
        
        const BugIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="8" y="6" width="8" height="14" rx="4"></rect>
                <path d="m19 7-3 2"></path>
                <path d="m5 7 3 2"></path>
                <path d="m19 19-3-2"></path>
                <path d="m5 19 3-2"></path>
                <path d="M20 13h-4"></path>
                <path d="M4 13h4"></path>
                <path d="m10 4 1 2"></path>
                <path d="m14 4-1 2"></path>
            </svg>
        );
        
        const AlertCircleIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );
        
        const CheckCircleIcon = () => (
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );
        
        const MenuIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        function PythonIDE() {
            const [code, setCode] = useState(`# Welcome to Python IDE
# Write your Python code here and click Run

def greet(name):
    return f"Hello, {name}!"

# Example usage
name = "World"
message = greet(name)
print(message)

# Try some calculations
numbers = [1, 2, 3, 4, 5]
total = sum(numbers)
print(f"Sum of {numbers} = {total}")
`);
            const [output, setOutput] = useState('');
            const [isRunning, setIsRunning] = useState(false);
            const [errors, setErrors] = useState([]);
            const [warnings, setWarnings] = useState([]);
            const [isChecking, setIsChecking] = useState(false);
            const [showDebugger, setShowDebugger] = useState(false);
            const [showMenu, setShowMenu] = useState(false);

            // Auto-check syntax with debounce
            useEffect(() => {
                const timer = setTimeout(() => {
                    if (code.trim()) {
                        checkSyntax();
                    }
                }, 1500);

                return () => clearTimeout(timer);
            }, [code]);

            // Load saved code from localStorage
            useEffect(() => {
                const savedCode = localStorage.getItem('pythonCode');
                if (savedCode) {
                    setCode(savedCode);
                }
            }, []);

            // Save code to localStorage
            useEffect(() => {
                localStorage.setItem('pythonCode', code);
            }, [code]);

            const checkSyntax = async () => {
                setIsChecking(true);
                
                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1000,
                            messages: [{
                                role: 'user',
                                content: `Analyze this Python code for syntax errors, potential bugs, and code quality issues. Return your response as JSON with this structure:
{
  "errors": [{"line": number, "message": "description", "type": "error"}],
  "warnings": [{"line": number, "message": "description", "type": "warning"}]
}

Only include actual issues. If there are no issues, return empty arrays.

Code:
\`\`\`python
${code}
\`\`\``
                            }]
                        })
                    });

                    const data = await response.json();
                    const result = data.content.map(item => item.type === 'text' ? item.text : '').join('\n');
                    
                    try {
                        const jsonMatch = result.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const parsed = JSON.parse(jsonMatch[0]);
                            setErrors(parsed.errors || []);
                            setWarnings(parsed.warnings || []);
                        } else {
                            setErrors([]);
                            setWarnings([]);
                        }
                    } catch (e) {
                        setErrors([]);
                        setWarnings([]);
                    }
                } catch (error) {
                    console.error('Syntax check error:', error);
                } finally {
                    setIsChecking(false);
                }
            };

            const runCode = async () => {
                setIsRunning(true);
                setOutput('Running code...\n');
                
                try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 1000,
                            messages: [{
                                role: 'user',
                                content: `Execute this Python code and provide the output. If there are any runtime errors, show them clearly with line numbers if possible. Provide ONLY the output/errors that would appear when running this code:\n\n${code}`
                            }]
                        })
                    });

                    const data = await response.json();
                    const result = data.content.map(item => item.type === 'text' ? item.text : '').join('\n');
                    setOutput(result);
                    
                    if (result.toLowerCase().includes('error') || result.toLowerCase().includes('exception')) {
                        await checkSyntax();
                    }
                } catch (error) {
                    setOutput(`Error: ${error.message}`);
                } finally {
                    setIsRunning(false);
                }
            };

            const clearOutput = () => {
                setOutput('');
            };

            const resetCode = () => {
                setCode(`# Welcome to Python IDE
# Write your Python code here and click Run

def greet(name):
    return f"Hello, {name}!"

# Example usage
name = "World"
message = greet(name)
print(message)
`);
                setOutput('');
            };

            const downloadCode = () => {
                const blob = new Blob([code], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'script.py';
                a.click();
                URL.revokeObjectURL(url);
            };

            const jumpToLine = (lineNum) => {
                const textarea = document.querySelector('textarea');
                const lines = code.split('\n');
                let pos = 0;
                for (let i = 0; i < lineNum - 1; i++) {
                    pos += lines[i].length + 1;
                }
                textarea.focus();
                textarea.setSelectionRange(pos, pos + (lines[lineNum - 1]?.length || 0));
                textarea.scrollTop = (lineNum - 1) * 24 - 100;
                setShowDebugger(false);
            };

            return (
                <div className="flex flex-col h-screen bg-gray-900 text-gray-100">
                    {/* Header */}
                    <div className="bg-gray-800 border-b border-gray-700 px-3 py-2 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <h1 className="text-base font-semibold">Python IDE</h1>
                            <div className="flex items-center gap-1 text-xs">
                                {isChecking ? (
                                    <span className="text-yellow-400">Checking...</span>
                                ) : errors.length > 0 ? (
                                    <div className="flex items-center gap-1 text-red-400">
                                        <AlertCircleIcon />
                                        <span>{errors.length}</span>
                                    </div>
                                ) : warnings.length > 0 ? (
                                    <div className="flex items-center gap-1 text-yellow-400">
                                        <AlertCircleIcon />
                                        <span>{warnings.length}</span>
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-1 text-green-400">
                                        <CheckCircleIcon />
                                    </div>
                                )}
                            </div>
                        </div>
                        <button
                            onClick={() => setShowMenu(!showMenu)}
                            className="p-2 hover:bg-gray-700 rounded"
                        >
                            <MenuIcon />
                        </button>
                    </div>

                    {/* Mobile Menu */}
                    {showMenu && (
                        <div className="bg-gray-800 border-b border-gray-700 p-2 flex flex-wrap gap-2">
                            <button
                                onClick={() => { runCode(); setShowMenu(false); }}
                                disabled={isRunning}
                                className="flex items-center gap-2 px-3 py-2 bg-green-600 disabled:bg-gray-600 rounded text-sm font-medium flex-1"
                            >
                                <PlayIcon />
                                {isRunning ? 'Running...' : 'Run'}
                            </button>
                            <button
                                onClick={() => { setShowDebugger(!showDebugger); setShowMenu(false); }}
                                className={`flex items-center gap-2 px-3 py-2 rounded text-sm font-medium ${
                                    showDebugger ? 'bg-blue-600' : 'bg-gray-700'
                                }`}
                            >
                                <BugIcon />
                                Debug
                            </button>
                            <button
                                onClick={() => { resetCode(); setShowMenu(false); }}
                                className="flex items-center gap-2 px-3 py-2 bg-gray-700 rounded text-sm font-medium"
                            >
                                <RotateCcwIcon />
                                Reset
                            </button>
                            <button
                                onClick={() => { downloadCode(); setShowMenu(false); }}
                                className="flex items-center gap-2 px-3 py-2 bg-gray-700 rounded text-sm font-medium"
                            >
                                <SaveIcon />
                                Save
                            </button>
                        </div>
                    )}

                    {/* Main content */}
                    <div className="flex-1 flex flex-col overflow-hidden">
                        {!showDebugger ? (
                            <>
                                {/* Code Editor */}
                                <div className="flex-1 flex flex-col border-b border-gray-700">
                                    <div className="bg-gray-800 px-3 py-2 border-b border-gray-700 text-sm font-medium">
                                        Editor
                                    </div>
                                    <div className="flex-1 overflow-hidden relative">
                                        <div className="absolute inset-0 flex">
                                            {/* Line numbers */}
                                            <div className="bg-gray-800 px-2 py-3 text-right select-none" style={{ minWidth: '40px' }}>
                                                {code.split('\n').map((_, index) => {
                                                    const lineNum = index + 1;
                                                    const hasError = errors.some(e => e.line === lineNum);
                                                    const hasWarning = warnings.some(w => w.line === lineNum);
                                                    return (
                                                        <div
                                                            key={index}
                                                            className={`font-mono text-xs leading-6 ${
                                                                hasError ? 'text-red-400 font-bold' : 
                                                                hasWarning ? 'text-yellow-400 font-bold' : 
                                                                'text-gray-500'
                                                            }`}
                                                            style={{ height: '24px' }}
                                                        >
                                                            {hasError && <span className="mr-1">●</span>}
                                                            {!hasError && hasWarning && <span className="mr-1">⚠</span>}
                                                            {lineNum}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            
                                            {/* Code area */}
                                            <div className="flex-1 relative overflow-auto">
                                                {/* Background highlights */}
                                                <div className="absolute inset-0 pointer-events-none line-highlight">
                                                    {code.split('\n').map((_, index) => {
                                                        const lineNum = index + 1;
                                                        const hasError = errors.some(e => e.line === lineNum);
                                                        const hasWarning = warnings.some(w => w.line === lineNum);
                                                        if (!hasError && !hasWarning) return null;
                                                        return (
                                                            <div
                                                                key={index}
                                                                className={`${
                                                                    hasError
                                                                        ? 'bg-red-500/10 border-l-2 border-red-500'
                                                                        : 'bg-yellow-500/10 border-l-2 border-yellow-500'
                                                                }`}
                                                                style={{
                                                                    position: 'absolute',
                                                                    top: `${index * 24}px`,
                                                                    left: 0,
                                                                    right: 0,
                                                                    height: '24px'
                                                                }}
                                                            />
                                                        );
                                                    })}
                                                </div>
                                                
                                                {/* Textarea */}
                                                <textarea
                                                    value={code}
                                                    onChange={(e) => setCode(e.target.value)}
                                                    className="w-full h-full px-3 py-3 bg-transparent text-gray-100 font-mono text-sm resize-none focus:outline-none relative z-10"
                                                    spellCheck="false"
                                                    style={{
                                                        tabSize: 4,
                                                        lineHeight: '24px',
                                                        minHeight: '100%'
                                                    }}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Output Panel */}
                                <div className="flex-1 flex flex-col">
                                    <div className="bg-gray-800 px-3 py-2 border-b border-gray-700 flex items-center justify-between">
                                        <span className="text-sm font-medium">Output</span>
                                        <button
                                            onClick={clearOutput}
                                            className="text-xs text-gray-400 hover:text-gray-200"
                                        >
                                            Clear
                                        </button>
                                    </div>
                                    <div className="flex-1 p-3 bg-gray-950 overflow-auto">
                                        <pre className="text-xs font-mono text-green-400 whitespace-pre-wrap">
                                            {output || 'Output will appear here...'}
                                        </pre>
                                    </div>
                                </div>
                            </>
                        ) : (
                            /* Debugger Panel - Full Screen on Mobile */
                            <div className="flex-1 flex flex-col bg-gray-900">
                                <div className="bg-gray-800 px-3 py-2 border-b border-gray-700 flex items-center justify-between">
                                    <span className="text-sm font-medium">Debugger</span>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => checkSyntax()}
                                            className="text-xs text-blue-400 hover:text-blue-300"
                                        >
                                            Recheck
                                        </button>
                                        <button
                                            onClick={() => setShowDebugger(false)}
                                            className="text-xs text-gray-400 hover:text-gray-200"
                                        >
                                            Close
                                        </button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-3">
                                    {isChecking ? (
                                        <div className="text-sm text-gray-400">Analyzing code...</div>
                                    ) : errors.length === 0 && warnings.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center h-full text-center">
                                            <CheckCircleIcon />
                                            <p className="text-sm text-gray-400 mt-2">No issues found</p>
                                            <p className="text-xs text-gray-500 mt-1">Your code looks good!</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-3">
                                            {errors.map((error, index) => (
                                                <div 
                                                    key={`error-${index}`} 
                                                    className="bg-red-900/20 border border-red-500/50 rounded p-3 active:bg-red-900/30"
                                                    onClick={() => jumpToLine(error.line)}
                                                >
                                                    <div className="flex items-start gap-2">
                                                        <AlertCircleIcon />
                                                        <div className="flex-1">
                                                            <div className="text-xs text-red-400 font-semibold mb-1">
                                                                ERROR {error.line ? `(Line ${error.line})` : ''}
                                                            </div>
                                                            <div className="text-sm text-gray-200">{error.message}</div>
                                                            {error.line && (
                                                                <div className="text-xs text-gray-400 mt-1">Tap to jump to line</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                            {warnings.map((warning, index) => (
                                                <div 
                                                    key={`warning-${index}`} 
                                                    className="bg-yellow-900/20 border border-yellow-500/50 rounded p-3 active:bg-yellow-900/30"
                                                    onClick={() => jumpToLine(warning.line)}
                                                >
                                                    <div className="flex items-start gap-2">
                                                        <AlertCircleIcon />
                                                        <div className="flex-1">
                                                            <div className="text-xs text-yellow-400 font-semibold mb-1">
                                                                WARNING {warning.line ? `(Line ${warning.line})` : ''}
                                                            </div>
                                                            <div className="text-sm text-gray-200">{warning.message}</div>
                                                            {warning.line && (
                                                                <div className="text-xs text-gray-400 mt-1">Tap to jump to line</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<PythonIDE />, document.getElementById('root'));
    </script>
    
    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>